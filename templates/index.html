<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Robot Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans p-4">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <div class="w-full max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 space-y-8">
        <header class="text-center pb-4 border-b border-gray-200">
            <h1 class="text-5xl font-extrabold text-blue-700">HosBot Delivery Control</h1>
            <p class="text-gray-500 mt-2">Manage orders, monitor status, and control the robot.</p>
        </header>

        <!-- Top Controls Section -->
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 p-4 bg-gray-50 rounded-lg border">
            <!-- Emergency Stop -->
            <button id="emergency-stop-btn"
                class="w-full md:w-auto px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-105"
                onclick="sendEmergencyStop()">
                ðŸš¨ EMERGENCY STOP
            </button>
            
            <!-- Manual Control Link -->
            <a href="/manual" 
                class="w-full md:w-auto text-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg transition duration-150 ease-in-out transform hover:scale-105">
                Manual Drive Control â†’
            </a>
        </div>

        <!-- Main Layout: Order Form and Queue -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Column 1: New Delivery Order Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl border border-gray-200 shadow-md h-fit">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Create New Delivery</h2>
                
                <form id="order-form" onsubmit="handleOrderSubmission(event)">
                    <div class="space-y-4">
                        
                        <div>
                            <label for="destination" class="block text-sm font-medium text-gray-700">Destination (Room/Station)</label>
                            <input type="text" id="destination" name="destination" required 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="patient" class="block text-sm font-medium text-gray-700">Patient/Recipient Name</label>
                            <input type="text" id="patient" name="patient" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="drawer" class="block text-sm font-medium text-gray-700">Robot Drawer ID (1, 2, or 3)</label>
                            <input type="number" id="drawer" name="drawer" min="1" max="3" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="contents" class="block text-sm font-medium text-gray-700">Contents Summary (e.g., Medicine, Lab Sample)</label>
                            <input type="text" id="contents" name="contents" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        
                        <div class="pt-4">
                            <button type="submit" 
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Submit Order
                            </button>
                        </div>
                        
                    </div>
                </form>

                <div id="form-message" class="mt-4 p-3 rounded-lg text-sm text-center hidden"></div>
            </div>

            <!-- Column 2: Order Queue and Status -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Current Order Queue</h2>
                
                {% if orders %}
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                    {% for order in orders | reverse %}
                        <div class="p-4 rounded-lg shadow-sm {{ 'bg-yellow-50 border-yellow-300' if order.status == 'QUEUED' else 'bg-green-50 border-green-300' }} border-l-4">
                            <div class="flex justify-between items-start">
                                <p class="text-lg font-semibold text-gray-800">{{ order.data.destination }} ({{ order.data.patient }})</p>
                                <span class="px-2 py-1 text-xs font-medium rounded-full {{ 'bg-yellow-200 text-yellow-800' if order.status == 'QUEUED' else 'bg-green-200 text-green-800' }}">
                                    {{ order.status }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Contents: {{ order.data.contents }} in Drawer {{ order.data.drawer }}</p>
                            <p class="text-xs text-gray-400 mt-2">ID: {{ order.id | round(2) }}</p>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-gray-500 py-8 border-dashed border-2 border-gray-300 rounded-lg">No active orders in the queue.</p>
                {% endif %}
            </div>
            
        </div>

    </div>

    <script>
        const ORDER_API = '/api/orders';
        const STOP_API = '/api/stop';
        const formMessage = document.getElementById('form-message');

        /**
         * Sends an AJAX request to submit a new order to the ROS node.
         * @param {Event} e - The form submission event.
         */
        async function handleOrderSubmission(e) {
            e.preventDefault();
            
            const form = e.target;
            const data = {
                destination: form.destination.value,
                patient: form.patient.value,
                drawer: form.drawer.value,
                contents: form.contents.value
            };

            formMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center text-gray-700 bg-gray-200';
            formMessage.textContent = 'Submitting order...';
            formMessage.classList.remove('hidden');

            try {
                const response = await fetch(ORDER_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();

                if (result.ok) {
                    formMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center text-green-800 bg-green-100';
                    formMessage.textContent = 'Order successfully published!';
                    form.reset();
                    // Reload the page to show the new order in the queue
                    setTimeout(() => window.location.reload(), 1000); 
                } else {
                    formMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center text-red-800 bg-red-100';
                    formMessage.textContent = `Error: ${result.error}`;
                }

            } catch (error) {
                formMessage.className = 'mt-4 p-3 rounded-lg text-sm text-center text-red-800 bg-red-100';
                formMessage.textContent = `Connection Error: ${error.message}`;
            }
        }

        /**
         * Sends an AJAX request to stop the robot immediately.
         */
        async function sendEmergencyStop() {
            if (!confirm("Are you sure you want to send the EMERGENCY STOP command?")) {
                return;
            }

            const stopButton = document.getElementById('emergency-stop-btn');
            const originalText = stopButton.textContent;
            stopButton.textContent = 'ðŸ›‘ Sending Stop...';
            stopButton.disabled = true;

            try {
                await fetch(STOP_API, { method: 'POST' });
                alert("EMERGENCY STOP signal sent successfully!");
            } catch (error) {
                alert(`Error sending stop signal: ${error.message}`);
            } finally {
                stopButton.textContent = originalText;
                stopButton.disabled = false;
            }
        }

        // Use custom modal for confirmation instead of browser 'confirm'
        function confirm(message) {
            return window.confirm(message); // Using window.confirm temporarily for quick testing
        }

        function alert(message) {
             console.log(message); // Log to console, or replace with a custom modal display
        }
    </script>
</body>
</html>